<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="James E. Pustejovsky">


<meta name="date" content="2017-09-19">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="experimental-design-1.html">
<link rel="next" href="design-analysis-and-presentation-of-simulation-results.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#purpose-of-simulations"><i class="fa fa-check"></i><b>1.1</b> Purpose of simulations</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#why-r"><i class="fa fa-check"></i><b>1.2</b> Why R?</a><ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#functions"><i class="fa fa-check"></i><b>1.2.1</b> Functions</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#function-skeletons"><i class="fa fa-check"></i><b>1.2.2</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>2</b> Structure of a simulation study</a><ul>
<li class="chapter" data-level="2.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#structure-of-a-simulation-study-1"><i class="fa fa-check"></i><b>2.1</b> Structure of a simulation study</a><ul>
<li class="chapter" data-level="2.1.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#experimental-design"><i class="fa fa-check"></i><b>2.1.1</b> Experimental design</a></li>
<li class="chapter" data-level="2.1.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model"><i class="fa fa-check"></i><b>2.1.2</b> Data-generating model</a></li>
<li class="chapter" data-level="2.1.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-methods"><i class="fa fa-check"></i><b>2.1.3</b> Estimation methods</a></li>
<li class="chapter" data-level="2.1.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>2.1.4</b> Performance summaries</a></li>
<li class="chapter" data-level="2.1.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#results"><i class="fa fa-check"></i><b>2.1.5</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#modular-simulations"><i class="fa fa-check"></i><b>2.2</b> Modular simulations</a></li>
<li class="chapter" data-level="2.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#a-first-example-heteroskedasticity-anova"><i class="fa fa-check"></i><b>2.3</b> A first example: Heteroskedasticity ANOVA</a><ul>
<li class="chapter" data-level="2.3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model-1"><i class="fa fa-check"></i><b>2.3.1</b> Data-generating model</a></li>
<li class="chapter" data-level="2.3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-procedures"><i class="fa fa-check"></i><b>2.3.2</b> Estimation procedures</a></li>
<li class="chapter" data-level="2.3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#replicate"><i class="fa fa-check"></i><b>2.3.3</b> Replicate</a></li>
<li class="chapter" data-level="2.3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#calculating-rejection-rates"><i class="fa fa-check"></i><b>2.3.4</b> Calculating rejection rates</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#exercises"><i class="fa fa-check"></i><b>2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-generating-models.html"><a href="data-generating-models.html"><i class="fa fa-check"></i><b>3</b> Data-generating models</a><ul>
<li class="chapter" data-level="3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#efficiency-versus-simplicity"><i class="fa fa-check"></i><b>3.1</b> Efficiency versus simplicity</a></li>
<li class="chapter" data-level="3.2" data-path="data-generating-models.html"><a href="data-generating-models.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>3.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="3.3" data-path="data-generating-models.html"><a href="data-generating-models.html#exercises-1"><i class="fa fa-check"></i><b>3.3</b> Exercises</a><ul>
<li class="chapter" data-level="3.3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#shifted-and-scaled-t-distribution"><i class="fa fa-check"></i><b>3.3.1</b> Shifted-and-scaled t distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html"><i class="fa fa-check"></i><b>4</b> Estimation procedures</a><ul>
<li class="chapter" data-level="4.1" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#efficiency-considerations"><i class="fa fa-check"></i><b>4.1</b> Efficiency considerations</a></li>
<li class="chapter" data-level="4.2" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#checking-the-estimation-functions"><i class="fa fa-check"></i><b>4.2</b> Checking the estimation function(s)</a></li>
<li class="chapter" data-level="4.3" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#exercises-2"><i class="fa fa-check"></i><b>4.3</b> Exercises</a><ul>
<li class="chapter" data-level="4.3.1" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#estimation-helper-function"><i class="fa fa-check"></i><b>4.3.1</b> Estimation helper function</a></li>
<li class="chapter" data-level="4.3.2" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#the-bff-test"><i class="fa fa-check"></i><b>4.3.2</b> The BFF* test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>5</b> Performance criteria</a><ul>
<li class="chapter" data-level="5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#parameter-estimation-absolute-criteria"><i class="fa fa-check"></i><b>5.1</b> Parameter estimation: absolute criteria</a></li>
<li class="chapter" data-level="5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#parameter-estimation-relative-criteria"><i class="fa fa-check"></i><b>5.2</b> Parameter estimation: relative criteria</a></li>
<li class="chapter" data-level="5.3" data-path="performance-criteria.html"><a href="performance-criteria.html#absolute-or-relative-performance"><i class="fa fa-check"></i><b>5.3</b> Absolute or relative performance?</a></li>
<li class="chapter" data-level="5.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-variance-estimators"><i class="fa fa-check"></i><b>5.4</b> Assessing variance estimators</a></li>
<li class="chapter" data-level="5.5" data-path="performance-criteria.html"><a href="performance-criteria.html#hypothesis-testing"><i class="fa fa-check"></i><b>5.5</b> Hypothesis testing</a></li>
<li class="chapter" data-level="5.6" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals"><i class="fa fa-check"></i><b>5.6</b> Confidence intervals</a></li>
<li class="chapter" data-level="5.7" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-simulating-cronbachs-alpha"><i class="fa fa-check"></i><b>5.7</b> Exercises: Simulating Cronbach’s alpha</a><ul>
<li class="chapter" data-level="5.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#data-generating-function"><i class="fa fa-check"></i><b>5.7.1</b> data-generating function</a></li>
<li class="chapter" data-level="5.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#estimation-function"><i class="fa fa-check"></i><b>5.7.2</b> Estimation function</a></li>
<li class="chapter" data-level="5.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#replicates"><i class="fa fa-check"></i><b>5.7.3</b> Replicates</a></li>
<li class="chapter" data-level="5.7.4" data-path="performance-criteria.html"><a href="performance-criteria.html#estimator-performance"><i class="fa fa-check"></i><b>5.7.4</b> Estimator performance</a></li>
<li class="chapter" data-level="5.7.5" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-interval-coverage"><i class="fa fa-check"></i><b>5.7.5</b> Confidence interval coverage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="experimental-design-1.html"><a href="experimental-design-1.html"><i class="fa fa-check"></i><b>6</b> Experimental design</a><ul>
<li class="chapter" data-level="6.1" data-path="experimental-design-1.html"><a href="experimental-design-1.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>6.1</b> Choosing parameter combinations</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html"><i class="fa fa-check"></i><b>7</b> Putting the pieces together</a><ul>
<li class="chapter" data-level="7.1" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#organizing-the-script-for-a-simulation-study"><i class="fa fa-check"></i><b>7.1</b> Organizing the script for a simulation study</a></li>
<li class="chapter" data-level="7.2" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#data-generating-model-2"><i class="fa fa-check"></i><b>7.2</b> data-generating model</a></li>
<li class="chapter" data-level="7.3" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#estimation-procedures-2"><i class="fa fa-check"></i><b>7.3</b> estimation procedures</a></li>
<li class="chapter" data-level="7.4" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#performance-calculations"><i class="fa fa-check"></i><b>7.4</b> Performance calculations</a></li>
<li class="chapter" data-level="7.5" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#simulation-driver"><i class="fa fa-check"></i><b>7.5</b> Simulation driver</a></li>
<li class="chapter" data-level="7.6" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#experimental-design-2"><i class="fa fa-check"></i><b>7.6</b> Experimental design</a></li>
<li class="chapter" data-level="7.7" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#putting-it-all-together"><i class="fa fa-check"></i><b>7.7</b> Putting it all together</a><ul>
<li class="chapter" data-level="7.7.1" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#mdply-workflow"><i class="fa fa-check"></i><b>7.7.1</b> <code>mdply</code> workflow</a></li>
<li class="chapter" data-level="7.7.2" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#purrrlyr-workflow"><i class="fa fa-check"></i><b>7.7.2</b> <code>purrrlyr</code> workflow</a></li>
<li class="chapter" data-level="7.7.3" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#parallel-processing"><i class="fa fa-check"></i><b>7.7.3</b> parallel processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>8</b> Design, analysis, and presentation of simulation results</a><ul>
<li class="chapter" data-level="8.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#designing-the-simulation-experiment"><i class="fa fa-check"></i><b>8.1</b> Designing the simulation experiment</a></li>
<li class="chapter" data-level="8.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#choosing-parameter-levels"><i class="fa fa-check"></i><b>8.2</b> Choosing parameter levels</a></li>
<li class="chapter" data-level="8.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation"><i class="fa fa-check"></i><b>8.3</b> Presentation</a></li>
<li class="chapter" data-level="8.4" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>8.4</b> Tabulation</a></li>
<li class="chapter" data-level="8.5" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>8.5</b> Visualization</a><ul>
<li class="chapter" data-level="8.5.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1"><i class="fa fa-check"></i><b>8.5.1</b> Example 1</a></li>
<li class="chapter" data-level="8.5.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-2"><i class="fa fa-check"></i><b>8.5.2</b> Example 2</a></li>
<li class="chapter" data-level="8.5.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-3-pustejovsky-swan-2014"><i class="fa fa-check"></i><b>8.5.3</b> Example 3 (Pustejovsky &amp; Swan, 2014)</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>8.6</b> Modeling</a><ul>
<li class="chapter" data-level="8.6.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1-1"><i class="fa fa-check"></i><b>8.6.1</b> Example 1</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation-1"><i class="fa fa-check"></i><b>8.7</b> Presentation</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="putting-the-pieces-together" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Putting the pieces together</h1>
<p>Earlier, I suggested that we can think of simulation studies as having five main components:</p>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-56-1.png" width="768" /></p>
<p>I also proposed that the code we write to implement simulations should follow the same structure, with different functions corresponding to each component. So far, we’ve looked at the middle three components:</p>
<ul>
<li>data-generating model</li>
<li>estimation methods</li>
<li>performance criteria</li>
</ul>
<p>In these notes, we’ll start to fill out the remainder, by looking at the overall organization of code for a simulation study. We’ll use as a running example the simulation of Cronbach’s <span class="math inline">\(\alpha\)</span> coefficient, which we saw in Class 17.</p>
<div id="organizing-the-script-for-a-simulation-study" class="section level2">
<h2><span class="header-section-number">7.1</span> Organizing the script for a simulation study</h2>
<p>In my methodological work, I try to always follow the same workflow when writing simulations. I make no claim that this is the only or best way to do things—only that it works for me. You see my template by doing the following:</p>
<ol style="list-style-type: decimal">
<li><p>Run the following code to install my personal package of helper functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">&quot;jepusto/Pusto&quot;</span>)</code></pre></div></li>
<li><p>Load the <code>Pusto</code> library and run the <code>Simulation_Skeleton()</code> function as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Pusto)
<span class="kw">Simulation_Skeleton</span>(<span class="st">&quot;Cronbach Alpha simulation&quot;</span>)</code></pre></div></li>
</ol>
<p>This function will open up a new R script for you, called <code>&quot;Cronbach Alpha simulation.R&quot;</code>, which contains a template for a simulation study, with sections corresponding to each component.</p>
</div>
<div id="data-generating-model-2" class="section level2">
<h2><span class="header-section-number">7.2</span> data-generating model</h2>
<p>The first two sections are about the data-generating model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())

<span class="co">#------------------------------------------------------</span>
<span class="co"># Set development values for simulation parameters</span>
<span class="co">#------------------------------------------------------</span>

<span class="co"># What are your model parameters?</span>
<span class="co"># What are your design parameters?</span>

<span class="co">#------------------------------------------------------</span>
<span class="co"># Data Generating Model</span>
<span class="co">#------------------------------------------------------</span>

dgm &lt;-<span class="st"> </span><span class="cf">function</span>(model_params) {

  <span class="kw">return</span>(dat)
}

<span class="co"># Test the data-generating model - How can you verify that it is correct?</span></code></pre></div>
<p>Here, we need to create and test a function that takes model parameters (and sample sizes and such) as inputs, and produces a simulated dataset. For the Cronbach alpha simulation, the function looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mvtnorm)
<span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())

<span class="co">#------------------------------------------------------</span>
<span class="co"># Set development values for simulation parameters</span>
<span class="co">#------------------------------------------------------</span>

<span class="co"># model parameters</span>
alpha &lt;-<span class="st"> </span><span class="fl">0.73</span> <span class="co"># true alpha</span>
df &lt;-<span class="st"> </span><span class="dv">12</span> <span class="co"># degrees of freedom</span>

<span class="co"># design parameters</span>
n &lt;-<span class="st"> </span><span class="dv">50</span> <span class="co"># sample size</span>
p &lt;-<span class="st"> </span><span class="dv">6</span> <span class="co"># number of items</span>

<span class="co">#------------------------------------------------------</span>
<span class="co"># Data Generating Model</span>
<span class="co">#------------------------------------------------------</span>

r_mvt_items &lt;-<span class="st"> </span><span class="cf">function</span>(n, p, alpha, df) {
  icc &lt;-<span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span>(p <span class="op">-</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>(p <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))
  V_mat &lt;-<span class="st"> </span>icc <span class="op">+</span><span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>icc, <span class="dt">nrow =</span> p)
  X &lt;-<span class="st"> </span><span class="kw">rmvt</span>(<span class="dt">n =</span> n, <span class="dt">sigma =</span> V_mat, <span class="dt">df =</span> df)
  <span class="kw">colnames</span>(X) &lt;-<span class="st"> </span>LETTERS[<span class="dv">1</span><span class="op">:</span>p]
  X
}

<span class="co"># Test the data-generating model</span>

big_sample &lt;-<span class="st"> </span><span class="kw">r_mvt_items</span>(<span class="dt">n =</span> <span class="dv">100000</span>, <span class="dt">p =</span> <span class="dv">4</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>)
<span class="kw">round</span>(<span class="kw">cor</span>(big_sample), <span class="dv">3</span>) <span class="co"># looks good</span></code></pre></div>
<pre><code>##       A     B     C     D
## A 1.000 0.402 0.411 0.399
## B 0.402 1.000 0.402 0.407
## C 0.411 0.402 1.000 0.397
## D 0.399 0.407 0.397 1.000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qqplot</span>(<span class="kw">qt</span>(<span class="kw">ppoints</span>(<span class="dv">200</span>), <span class="dt">df =</span> <span class="dv">5</span>), big_sample[,<span class="dv">2</span>], <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>,<span class="dv">4</span>))</code></pre></div>
<p><img src="Designing-Simulations-in-R_files/figure-html/unnamed-chunk-60-1.png" width="672" /></p>
</div>
<div id="estimation-procedures-2" class="section level2">
<h2><span class="header-section-number">7.3</span> estimation procedures</h2>
<p>The next section of the template looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#------------------------------------------------------</span>
<span class="co"># Model-fitting/estimation/testing functions</span>
<span class="co">#------------------------------------------------------</span>


estimate &lt;-<span class="st"> </span><span class="cf">function</span>(dat, design_params) {

  <span class="kw">return</span>(result)
}

<span class="co"># Test the estimation function</span></code></pre></div>
<p>Here, we need to create a function that takes simulated data as input (and possibly also design parameters, like sample size), and produces a set of estimates (or confidence intervals, or p-values, etc.). As usual, we should also test that the function is correct.</p>
<p>Here’s what this code looks like for the Cronbach alpha simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#------------------------------------------------------</span>
<span class="co"># Model-fitting/estimation/testing functions</span>
<span class="co">#------------------------------------------------------</span>

estimate_alpha &lt;-<span class="st"> </span><span class="cf">function</span>(dat, <span class="dt">coverage =</span> .<span class="dv">95</span>) {
  V &lt;-<span class="st"> </span><span class="kw">cov</span>(dat)
  p &lt;-<span class="st"> </span><span class="kw">ncol</span>(dat)
  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(dat)
  A &lt;-<span class="st"> </span>p <span class="op">/</span><span class="st"> </span>(p <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">diag</span>(V)) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(V))
  Var_A &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>p <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>((p <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>n)
  
  B &lt;-<span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>A) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>
  SE_B &lt;-<span class="st"> </span><span class="kw">sqrt</span>(p <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>n <span class="op">*</span><span class="st"> </span>(p <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)))
  z &lt;-<span class="st"> </span><span class="kw">qnorm</span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>coverage) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)
  CI_B &lt;-<span class="st"> </span>B <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>SE_B <span class="op">*</span><span class="st"> </span>z
  CI_A &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">exp</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>CI_B)
  
  <span class="kw">data.frame</span>(<span class="dt">A =</span> A, <span class="dt">Var_A =</span> Var_A, <span class="dt">CI_L =</span> CI_A[<span class="dv">1</span>], <span class="dt">CI_U =</span> CI_A[<span class="dv">2</span>])
}

<span class="co"># Test the estimation function</span>
small_sample &lt;-<span class="st"> </span><span class="kw">r_mvt_items</span>(<span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>)
<span class="kw">estimate_alpha</span>(small_sample)</code></pre></div>
<pre><code>##           A       Var_A      CI_L      CI_U
## 1 0.6322428 0.006491778 0.4349978 0.7606286</code></pre>
<p>The function takes a simulated dataset as input and spits out a point estimate of alpha, an estimate of the variance of alpha, and a confidence interval for alpha (at the 95% coverage level, by default).</p>
<p>We’ve already seen how to use the <code>replicate</code> function to generate a whole bunch of simulated estimates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alpha_sims &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">replicate</span>(<span class="dt">n =</span> <span class="dv">10</span>, {
    dat &lt;-<span class="st"> </span><span class="kw">r_mvt_items</span>(<span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>)
    <span class="kw">estimate_alpha</span>(dat)
  }, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">bind_rows</span>()

alpha_sims</code></pre></div>
<pre><code>##            A       Var_A      CI_L      CI_U
## 1  0.7841786 0.002235786 0.6684237 0.8595229
## 2  0.6318808 0.006504564 0.4344417 0.7603930
## 3  0.7156552 0.003880895 0.5631481 0.8149213
## 4  0.7436121 0.003155269 0.6060995 0.8331183
## 5  0.7138774 0.003929575 0.5604168 0.8137642
## 6  0.7666345 0.002614053 0.6414700 0.8481035
## 7  0.8464022 0.001132430 0.7640207 0.9000239
## 8  0.7614484 0.002731529 0.6335023 0.8447279
## 9  0.6262690 0.006704395 0.4258200 0.7567402
## 10 0.7805177 0.002312279 0.6627993 0.8571400</code></pre>
</div>
<div id="performance-calculations" class="section level2">
<h2><span class="header-section-number">7.4</span> Performance calculations</h2>
<p>The next section of the template deals with performance calculations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#------------------------------------------------------</span>
<span class="co"># Calculate performance measures</span>
<span class="co"># (For some simulations, it may make more sense</span>
<span class="co"># to do this as part of the simulation driver.)</span>
<span class="co">#------------------------------------------------------</span>

performance &lt;-<span class="st"> </span><span class="cf">function</span>(results, model_params) {

  <span class="kw">return</span>(performance_measures)
}

<span class="co"># Check performance calculations</span></code></pre></div>
<p>The <code>performance()</code> function takes as input a bunch of simulated data (which we might call <code>results</code>) and the true values of the model parameters (<code>model_params</code>) and returns as output a set of summary performance measures. As noted in the comments above, for simple simulations it might not be necessary to write a separate function to do these calculations. For more complex simulations, though, it can be helpful to break these calculations out in a function.</p>
<p>For the Cronbach alpha simulation, we might want to calculate the following performance measures:</p>
<ul>
<li>bias and root mean-squared error (RMSE) of the alpha point estimate</li>
<li>relative bias of the variance estimator</li>
<li>coverage of the confidence interval</li>
</ul>
<p>Here is a function that calculates these measures (along with Monte Carlo standard errors), given a data frame containing model results. It uses the jackknife technique to get Monte Carlo standard errors for the RMSE and relative bias.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#------------------------------------------------------</span>
<span class="co"># Calculate performance measures</span>
<span class="co">#------------------------------------------------------</span>

alpha_performance &lt;-<span class="st"> </span><span class="cf">function</span>(alpha_sims, alpha, <span class="dt">coverage_level =</span> .<span class="dv">95</span>) {
  
  <span class="co"># setup</span>
  K &lt;-<span class="st"> </span><span class="kw">nrow</span>(alpha_sims)
  A_err &lt;-<span class="st"> </span>alpha_sims<span class="op">$</span>A <span class="op">-</span><span class="st"> </span>alpha
  var_A &lt;-<span class="st"> </span><span class="kw">var</span>(alpha_sims<span class="op">$</span>A)
  
  <span class="co"># bias</span>
  A_bias &lt;-<span class="st"> </span><span class="kw">mean</span>(A_err)
  A_bias_MCSE &lt;-<span class="st"> </span><span class="kw">sqrt</span>(var_A <span class="op">/</span><span class="st"> </span>K)
  
  <span class="co"># RMSE</span>
  A_RMSE &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">mean</span>((A_err)<span class="op">^</span><span class="dv">2</span>))
  RMSE_j &lt;-<span class="st"> </span><span class="kw">sqrt</span>((A_RMSE<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>K <span class="op">-</span><span class="st"> </span>A_err<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))
  A_RMSE_MCSE &lt;-<span class="st"> </span><span class="kw">sd</span>(RMSE_j)
  
  <span class="co"># relative bias of variance estimator</span>
  V_bar &lt;-<span class="st"> </span><span class="kw">mean</span>(alpha_sims<span class="op">$</span>Var_A)
  V_j &lt;-<span class="st"> </span>(V_bar <span class="op">*</span><span class="st"> </span>K <span class="op">-</span><span class="st"> </span>alpha_sims<span class="op">$</span>Var_A) <span class="op">/</span><span class="st"> </span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
  Ssq_j &lt;-<span class="st"> </span>((K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>var_A <span class="op">-</span><span class="st"> </span>A_err<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>K <span class="op">/</span><span class="st"> </span>(K <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) <span class="op">/</span><span class="st"> </span>(K <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)
  RB_j &lt;-<span class="st"> </span>V_j <span class="op">/</span><span class="st"> </span>Ssq_j
  V_relbias &lt;-<span class="st"> </span>V_bar <span class="op">/</span><span class="st"> </span>var_A
  V_relbias_MCSE &lt;-<span class="st"> </span><span class="kw">sd</span>(RB_j)
  
  <span class="co"># coverage</span>
  coverage &lt;-<span class="st"> </span><span class="kw">mean</span>(alpha_sims<span class="op">$</span>CI_L <span class="op">&lt;</span><span class="st"> </span>alpha <span class="op">&amp;</span><span class="st"> </span>alpha <span class="op">&lt;</span><span class="st"> </span>alpha_sims<span class="op">$</span>CI_U)
  coverage_MCSE &lt;-<span class="st"> </span><span class="kw">sqrt</span>(coverage_level <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>coverage_level) <span class="op">/</span><span class="st"> </span>K)
  
  <span class="kw">data.frame</span>(
    <span class="dt">criterion =</span> <span class="kw">c</span>(<span class="st">&quot;alpha bias&quot;</span>,<span class="st">&quot;alpha RMSE&quot;</span>, <span class="st">&quot;V relative bias&quot;</span>, <span class="st">&quot;coverage&quot;</span>),
    <span class="dt">est =</span> <span class="kw">c</span>(A_bias, A_RMSE, V_relbias, coverage),
    <span class="dt">MCSE =</span> <span class="kw">c</span>(A_bias_MCSE, A_RMSE_MCSE, V_relbias_MCSE, coverage_MCSE)
  )
}

<span class="co"># Check performance calculations</span>
<span class="kw">alpha_performance</span>(alpha_sims, <span class="dt">alpha =</span> <span class="fl">0.73</span>)</code></pre></div>
<pre><code>##         criterion        est        MCSE
## 1      alpha bias 0.00704758 0.021579244
## 2      alpha RMSE 0.06512021 0.004456856
## 3 V relative bias 0.75592686 0.138056334
## 4        coverage 0.90000000 0.068920244</code></pre>
</div>
<div id="simulation-driver" class="section level2">
<h2><span class="header-section-number">7.5</span> Simulation driver</h2>
<p>We now have all the components we need to get simulation results, given a set of parameter values. In the next section of the template, we put all these pieces together in a function—which we might call the <em>simulation driver</em>—that takes as input 1) parameter values, 2) the desired number of replications, and 3) optionally, a seed value. The function produces as output a single set of performance estimates. Generically, the function looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#-----------------------------------------------------------</span>
<span class="co"># Simulation Driver - should return a data.frame or tibble</span>
<span class="co">#-----------------------------------------------------------</span>

runSim &lt;-<span class="st"> </span><span class="cf">function</span>(iterations, model_params, design_params, <span class="dt">seed =</span> <span class="ot">NULL</span>) {
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(seed)) <span class="kw">set.seed</span>(seed)

  results &lt;-<span class="st"> </span><span class="kw">replicate</span>(iterations, {
                dat &lt;-<span class="st"> </span><span class="kw">dgm</span>(model_params)
                <span class="kw">estimate</span>(dat, design_params)
              })

  <span class="kw">performance</span>(results, model_params)
}

<span class="co"># demonstrate the simulation driver</span></code></pre></div>
<p>The <code>runSim</code> function should require very little modification for a new simulation. Essentially, all we need to change is the names of the functions that are called, so that they line up with the functions we have designed for our simulation. Here’s what this looks like for the Cronbach alpha simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#-----------------------------------------------------------</span>
<span class="co"># Simulation Driver - should return a data.frame or tibble</span>
<span class="co">#-----------------------------------------------------------</span>

run_alpha_sim &lt;-<span class="st"> </span><span class="cf">function</span>(iterations, n, p, alpha, df, <span class="dt">coverage =</span> <span class="fl">0.95</span>, <span class="dt">seed =</span> <span class="ot">NULL</span>) {
  
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(seed)) <span class="kw">set.seed</span>(seed)

  results &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">replicate</span>(<span class="dt">n =</span> iterations, {
      dat &lt;-<span class="st"> </span><span class="kw">r_mvt_items</span>(<span class="dt">n =</span> n, <span class="dt">p =</span> p, <span class="dt">alpha =</span> alpha, <span class="dt">df =</span> df)
      <span class="kw">estimate_alpha</span>(dat, <span class="dt">coverage =</span> coverage)
    }, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">bind_rows</span>()
  
  <span class="kw">alpha_performance</span>(results, <span class="dt">alpha =</span> alpha, <span class="dt">coverage =</span> coverage)
}

<span class="co"># demonstrate the simulation driver</span>
<span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">10</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion          est        MCSE
## 1      alpha bias -0.006834839 0.043602710
## 2      alpha RMSE  0.130986570 0.008398788
## 3 V relative bias  0.236688771 0.024706868
## 4        coverage  0.600000000 0.068920244</code></pre>
<p>Because this function involves generating random numbers, re-running it with the exact same input parameters will still produce different results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">10</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion         est        MCSE
## 1      alpha bias -0.01454455 0.029200507
## 2      alpha RMSE  0.08880073 0.006142837
## 3 V relative bias  0.49898603 0.061950577
## 4        coverage  0.80000000 0.068920244</code></pre>
<p>Of course, using a larger number of iterations will give us more precise estimates of the performance criteria. If we want to get the <em>exact</em> same results, we can feed the function a seed value:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">10</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>, <span class="dt">seed =</span> <span class="dv">6</span>)</code></pre></div>
<pre><code>##         criterion         est       MCSE
## 1      alpha bias -0.02053560 0.02585963
## 2      alpha RMSE  0.08025083 0.01344827
## 3 V relative bias  0.64909209 1.43035647
## 4        coverage  0.90000000 0.06892024</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">10</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">6</span>, <span class="dt">alpha =</span> <span class="fl">0.73</span>, <span class="dt">df =</span> <span class="dv">5</span>, <span class="dt">seed =</span> <span class="dv">6</span>)</code></pre></div>
<pre><code>##         criterion         est       MCSE
## 1      alpha bias -0.02053560 0.02585963
## 2      alpha RMSE  0.08025083 0.01344827
## 3 V relative bias  0.64909209 1.43035647
## 4        coverage  0.90000000 0.06892024</code></pre>
<p>This is useful because it ensure the full reproducibility of the results. In practice, it is a good idea to always set seed values for your simulations, so that you (or someone else!) can exactly reproduce the results.</p>
</div>
<div id="experimental-design-2" class="section level2">
<h2><span class="header-section-number">7.6</span> Experimental design</h2>
<p>The next section of the template looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">20150316</span>) <span class="co"># change this seed value!</span>

<span class="co"># now express the simulation parameters as vectors/lists</span>

design_factors &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">factor1 =</span> , <span class="dt">factor2 =</span> , ...) <span class="co"># combine into a design set</span>
params &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(design_factors)
params<span class="op">$</span>iterations &lt;-<span class="st"> </span><span class="dv">5</span>
params<span class="op">$</span>seed &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">30</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(params)

<span class="co"># All look right?</span>
<span class="kw">lengths</span>(design_factors)
<span class="kw">nrow</span>(params)
<span class="kw">head</span>(params)</code></pre></div>
<p>For the Cronbach alpha simulation, we might want to vary</p>
<ul>
<li>the true value of alpha, with values ranging from 0.1 to 0.9;</li>
<li>the degrees of freedom of the multivariate t distribution, with values of 5, 10, 20, or 100;</li>
<li>the sample size, with values of 50 or 100; and</li>
<li>the number of items, with values of 4 or 8.</li>
</ul>
<p>Here is code that implements this design, using 500 replications per condition:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">20170405</span>)

<span class="co"># now express the simulation parameters as vectors/lists</span>

design_factors &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">100</span>),
  <span class="dt">p =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">8</span>),
  <span class="dt">alpha =</span> <span class="kw">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.1</span>),
  <span class="dt">df =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">100</span>)
)

params &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(design_factors)
params<span class="op">$</span>iterations &lt;-<span class="st"> </span><span class="dv">50</span>
params<span class="op">$</span>seed &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">30</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(params)</code></pre></div>
<p>This gives us a <span class="math inline">\(2\times2\times9\times4\)</span> factorial design:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lengths</span>(design_factors)</code></pre></div>
<pre><code>##     n     p alpha    df 
##     2     2     9     4</code></pre>
<p>With a total of 144 cells.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(params)</code></pre></div>
<pre><code>## [1] 144</code></pre>
<p>The <code>params</code> data frame is a representation of the full experimental design:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(params)</code></pre></div>
<pre><code>##     n p alpha df iterations       seed
## 1  50 4   0.1  5         50 1047992101
## 2 100 4   0.1  5         50 1047992102
## 3  50 8   0.1  5         50 1047992103
## 4 100 8   0.1  5         50 1047992104
## 5  50 4   0.2  5         50 1047992105
## 6 100 4   0.2  5         50 1047992106</code></pre>
</div>
<div id="putting-it-all-together" class="section level2">
<h2><span class="header-section-number">7.7</span> Putting it all together</h2>
<p>In the previous sections, we’ve created code that will generate a set of performance estimates, given a set of parameter values. We’ve also created a dataset that represents every combination of parameter values that we want to examine. How do we put the pieces together?</p>
<p>If we only had a couple of parameter combinations, it would be easy enough to just call our <code>run_alpha_sim</code> function a couple of times:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">100</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">4</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion         est         MCSE
## 1      alpha bias -0.03641974 0.0099773396
## 2      alpha RMSE  0.10574299 0.0009324136
## 3 V relative bias  0.65916226 0.0108366286
## 4        coverage  0.84000000 0.0217944947</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">100</span>, <span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">p =</span> <span class="dv">4</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion         est         MCSE
## 1      alpha bias -0.01086245 0.0076446904
## 2      alpha RMSE  0.07683541 0.0007246681
## 3 V relative bias  0.46734606 0.0082316474
## 4        coverage  0.82000000 0.0217944947</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">100</span>, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">p =</span> <span class="dv">8</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion         est       MCSE
## 1      alpha bias -0.03251583 0.01051087
## 2      alpha RMSE  0.10952007 0.00138845
## 3 V relative bias  0.50276550 0.01258413
## 4        coverage  0.84000000 0.02179449</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run_alpha_sim</span>(<span class="dt">iterations =</span> <span class="dv">100</span>, <span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">p =</span> <span class="dv">8</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>, <span class="dt">df =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##         criterion         est        MCSE
## 1      alpha bias -0.01917588 0.007923788
## 2      alpha RMSE  0.08113920 0.001070873
## 3 V relative bias  0.39349401 0.010781848
## 4        coverage  0.85000000 0.021794495</code></pre>
<p>But the simulation that we’ve designed has 144 cells—too many to do this “by hand.” The next two sections of the simulation template demonstrate two different approaches to doing the calculations for <em>every</em> combination of parameter values. You’ll only need to use one of these approaches, so pick whichever you find easier.</p>
<div id="mdply-workflow" class="section level3">
<h3><span class="header-section-number">7.7.1</span> <code>mdply</code> workflow</h3>
<p>The first approach uses the <code>mdply</code> function from the <code>plyr</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#--------------------------------------------------------</span>
<span class="co"># run simulations in serial - mdply workflow</span>
<span class="co">#--------------------------------------------------------</span>

<span class="kw">system.time</span>(results &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw">mdply</span>(params, <span class="dt">.fun =</span> runSim))</code></pre></div>
<p>The main function here is <code>mdply</code>. I call it by specifying the package name first, followed by two colons, followed by the function name (this avoids the need to load the <code>plyr</code> package, which has a lot of conflicts with other packages such as <code>dplyr</code> and <code>tidyr</code>). The results are stored in an object called <code>results</code>. And the whole line is wrapped in a call to the <code>system.time</code> function, so that we’ll know how long the full set of calculations takes.</p>
<p>Here’s the syntax for the Cronbach alpha simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#--------------------------------------------------------</span>
<span class="co"># run simulations in serial - mdply workflow</span>
<span class="co">#--------------------------------------------------------</span>

<span class="kw">system.time</span>(results_mdply &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw">mdply</span>(params, <span class="dt">.fun =</span> run_alpha_sim))</code></pre></div>
<pre><code>##    user  system elapsed 
##   7.862   0.001   7.862</code></pre>
<p>The output is then as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(results_mdply, <span class="dt">n =</span> <span class="dv">12</span>)</code></pre></div>
<pre><code>##      n p alpha df iterations       seed       criterion         est
## 1   50 4   0.1  5         50 1047992101      alpha bias -0.08538795
## 2   50 4   0.1  5         50 1047992101      alpha RMSE  0.31148392
## 3   50 4   0.1  5         50 1047992101 V relative bias  0.61784942
## 4   50 4   0.1  5         50 1047992101        coverage  0.90000000
## 5  100 4   0.1  5         50 1047992102      alpha bias -0.06421672
## 6  100 4   0.1  5         50 1047992102      alpha RMSE  0.22382778
## 7  100 4   0.1  5         50 1047992102 V relative bias  0.55460480
## 8  100 4   0.1  5         50 1047992102        coverage  0.84000000
## 9   50 8   0.1  5         50 1047992103      alpha bias -0.01166624
## 10  50 8   0.1  5         50 1047992103      alpha RMSE  0.24503102
## 11  50 8   0.1  5         50 1047992103 V relative bias  0.66637452
## 12  50 8   0.1  5         50 1047992103        coverage  0.84000000
##           MCSE
## 1  0.042793079
## 2  0.008572716
## 3  0.040803129
## 4  0.030822070
## 5  0.030631146
## 6  0.003958238
## 7  0.020183400
## 8  0.030822070
## 9  0.034964735
## 10 0.004031325
## 11 0.020205867
## 12 0.030822070</code></pre>
<p>What’s going on here? The <code>mdply</code> function takes two main arguments: a data frame and a <em>function</em>. The specified function is then evaluated <em>for each row of the data frame</em>. The arguments to the function are matched to the variable names in the dataset, so the <code>params$alpha</code> is matched to the <code>alpha</code> argument of <code>run_alpha_sim</code>, <code>params$df</code> is matched to the <code>df</code> argument of <code>run_alpha_sim</code>, etc. Thus, <strong>it is crucial that the variable names in the <code>params</code> dataset exactly match the argument names of the simulation driver</strong>.</p>
<p>Additional arguments can also be specified after the function name; these will be used for every row of the dataset. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plyr<span class="op">::</span><span class="kw">mdply</span>(params, <span class="dt">.fun =</span> run_alpha_sim, <span class="dt">coverage =</span> <span class="fl">0.90</span>)</code></pre></div>
<p>Would calculate the coverage of 90% confidence intervals instead of the default 95% CIs.</p>
</div>
<div id="purrrlyr-workflow" class="section level3">
<h3><span class="header-section-number">7.7.2</span> <code>purrrlyr</code> workflow</h3>
<p>An alternative to <code>mdply</code> is to use the <code>invoke_rows</code> function from the <code>purrrlyr</code> package. The functions work almost identically, with a few little differences. One difference is that the <code>purrrlyr</code> package is designed to work well with <code>tidyr</code>, <code>dplyr</code> and the other tidyverse packages. We’ll see another difference below.</p>
<p>The simulation template includes the following code to execute the simulations using <code>invoke_rows</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#--------------------------------------------------------</span>
<span class="co"># run simulations in serial - purrrlyr workflow</span>
<span class="co">#--------------------------------------------------------</span>
<span class="kw">library</span>(purrrlyr)

<span class="kw">system.time</span>(
  results &lt;-<span class="st"> </span>
<span class="st">    </span>params <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">invoke_rows</span>(<span class="dt">.f =</span> runSim, <span class="dt">.to =</span> <span class="st">&quot;res&quot;</span>)
)</code></pre></div>
<p>The <code>invoke_rows</code> function takes two main arguments, just like <code>mdply</code>: the dataset and the function to evaluate. The function is called for each row of the dataset, again by matching the function arguments to the variable names. The result is stored in a new variable, with name specified by <code>.to</code>.</p>
<p>Here’s the syntax for the Cronbach alpha simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#--------------------------------------------------------</span>
<span class="co"># run simulations in serial - purrrlyr workflow</span>
<span class="co">#--------------------------------------------------------</span>
<span class="kw">library</span>(purrrlyr)

<span class="kw">system.time</span>(
  results_purrr &lt;-<span class="st"> </span>
<span class="st">    </span>params <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">invoke_rows</span>(<span class="dt">.f =</span> run_alpha_sim, <span class="dt">.to =</span> <span class="st">&quot;res&quot;</span>)
)</code></pre></div>
<pre><code>##    user  system elapsed 
##   7.803   0.000   7.803</code></pre>
<p>The result looks a bit different than the result of using <code>mdply</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(results_purrr, <span class="dt">n =</span> <span class="dv">12</span>)</code></pre></div>
<pre><code>## # A tibble: 12 x 7
##        n     p alpha    df iterations       seed                  res
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;               &lt;list&gt;
##  1    50     4   0.1     5         50 1047992101 &lt;data.frame [4 x 3]&gt;
##  2   100     4   0.1     5         50 1047992102 &lt;data.frame [4 x 3]&gt;
##  3    50     8   0.1     5         50 1047992103 &lt;data.frame [4 x 3]&gt;
##  4   100     8   0.1     5         50 1047992104 &lt;data.frame [4 x 3]&gt;
##  5    50     4   0.2     5         50 1047992105 &lt;data.frame [4 x 3]&gt;
##  6   100     4   0.2     5         50 1047992106 &lt;data.frame [4 x 3]&gt;
##  7    50     8   0.2     5         50 1047992107 &lt;data.frame [4 x 3]&gt;
##  8   100     8   0.2     5         50 1047992108 &lt;data.frame [4 x 3]&gt;
##  9    50     4   0.3     5         50 1047992109 &lt;data.frame [4 x 3]&gt;
## 10   100     4   0.3     5         50 1047992110 &lt;data.frame [4 x 3]&gt;
## 11    50     8   0.3     5         50 1047992111 &lt;data.frame [4 x 3]&gt;
## 12   100     8   0.3     5         50 1047992112 &lt;data.frame [4 x 3]&gt;</code></pre>
<p>The output has the same number of rows as params (compare to <code>results_mdply</code>, which has 576). The performance estimates are all in a single variable, called <code>res</code> in this case, and each observation is actually <em>its own little dataset</em>, or what is called a <strong>nested data frame</strong>. Nested data frames are nifty but odd little data structures, which are beyond the scope of this course. For now, we can turn the results into something easier to work with by using the <code>unnest</code> function from <code>tidyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
results_purrr <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">12</span>)</code></pre></div>
<pre><code>## # A tibble: 12 x 9
##        n     p alpha    df iterations       seed       criterion
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;          &lt;fctr&gt;
##  1    50     4   0.1     5         50 1047992101      alpha bias
##  2    50     4   0.1     5         50 1047992101      alpha RMSE
##  3    50     4   0.1     5         50 1047992101 V relative bias
##  4    50     4   0.1     5         50 1047992101        coverage
##  5   100     4   0.1     5         50 1047992102      alpha bias
##  6   100     4   0.1     5         50 1047992102      alpha RMSE
##  7   100     4   0.1     5         50 1047992102 V relative bias
##  8   100     4   0.1     5         50 1047992102        coverage
##  9    50     8   0.1     5         50 1047992103      alpha bias
## 10    50     8   0.1     5         50 1047992103      alpha RMSE
## 11    50     8   0.1     5         50 1047992103 V relative bias
## 12    50     8   0.1     5         50 1047992103        coverage
## # ... with 2 more variables: est &lt;dbl&gt;, MCSE &lt;dbl&gt;</code></pre>
</div>
<div id="parallel-processing" class="section level3">
<h3><span class="header-section-number">7.7.3</span> parallel processing</h3>
<p>The final two sections of the simulation template demonstrate how to execute the simulations in parallel, across multiple cores of a computer or computing cluster. We’ll look at the details here in a later class.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="experimental-design-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="design-analysis-and-presentation-of-simulation-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/06-Putting-the-pieces-together.Rmd",
"text": "Edit"
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
