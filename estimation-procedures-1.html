<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Designing Monte Carlo Simulations in R</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Designing Monte Carlo Simulations in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="jepusto/Designing-Simulations-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Designing Monte Carlo Simulations in R" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="James E. Pustejovsky">


<meta name="date" content="2017-09-19">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="data-generating-models.html">
<link rel="next" href="performance-criteria.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Designing Simulations in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#purpose-of-simulations"><i class="fa fa-check"></i><b>1.1</b> Purpose of simulations</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#why-r"><i class="fa fa-check"></i><b>1.2</b> Why R?</a><ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#functions"><i class="fa fa-check"></i><b>1.2.1</b> Functions</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#function-skeletons"><i class="fa fa-check"></i><b>1.2.2</b> Function skeletons</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html"><i class="fa fa-check"></i><b>2</b> Structure of a simulation study</a><ul>
<li class="chapter" data-level="2.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#structure-of-a-simulation-study-1"><i class="fa fa-check"></i><b>2.1</b> Structure of a simulation study</a><ul>
<li class="chapter" data-level="2.1.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#experimental-design"><i class="fa fa-check"></i><b>2.1.1</b> Experimental design</a></li>
<li class="chapter" data-level="2.1.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model"><i class="fa fa-check"></i><b>2.1.2</b> Data-generating model</a></li>
<li class="chapter" data-level="2.1.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-methods"><i class="fa fa-check"></i><b>2.1.3</b> Estimation methods</a></li>
<li class="chapter" data-level="2.1.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#performance-summaries"><i class="fa fa-check"></i><b>2.1.4</b> Performance summaries</a></li>
<li class="chapter" data-level="2.1.5" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#results"><i class="fa fa-check"></i><b>2.1.5</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#modular-simulations"><i class="fa fa-check"></i><b>2.2</b> Modular simulations</a></li>
<li class="chapter" data-level="2.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#a-first-example-heteroskedasticity-anova"><i class="fa fa-check"></i><b>2.3</b> A first example: Heteroskedasticity ANOVA</a><ul>
<li class="chapter" data-level="2.3.1" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#data-generating-model-1"><i class="fa fa-check"></i><b>2.3.1</b> Data-generating model</a></li>
<li class="chapter" data-level="2.3.2" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#estimation-procedures"><i class="fa fa-check"></i><b>2.3.2</b> Estimation procedures</a></li>
<li class="chapter" data-level="2.3.3" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#replicate"><i class="fa fa-check"></i><b>2.3.3</b> Replicate</a></li>
<li class="chapter" data-level="2.3.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#calculating-rejection-rates"><i class="fa fa-check"></i><b>2.3.4</b> Calculating rejection rates</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="structure-of-a-simulation-study.html"><a href="structure-of-a-simulation-study.html#exercises"><i class="fa fa-check"></i><b>2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-generating-models.html"><a href="data-generating-models.html"><i class="fa fa-check"></i><b>3</b> Data-generating models</a><ul>
<li class="chapter" data-level="3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#efficiency-versus-simplicity"><i class="fa fa-check"></i><b>3.1</b> Efficiency versus simplicity</a></li>
<li class="chapter" data-level="3.2" data-path="data-generating-models.html"><a href="data-generating-models.html#checking-the-data-generating-function"><i class="fa fa-check"></i><b>3.2</b> Checking the data-generating function</a></li>
<li class="chapter" data-level="3.3" data-path="data-generating-models.html"><a href="data-generating-models.html#exercises-1"><i class="fa fa-check"></i><b>3.3</b> Exercises</a><ul>
<li class="chapter" data-level="3.3.1" data-path="data-generating-models.html"><a href="data-generating-models.html#shifted-and-scaled-t-distribution"><i class="fa fa-check"></i><b>3.3.1</b> Shifted-and-scaled t distribution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html"><i class="fa fa-check"></i><b>4</b> Estimation procedures</a><ul>
<li class="chapter" data-level="4.1" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#efficiency-considerations"><i class="fa fa-check"></i><b>4.1</b> Efficiency considerations</a></li>
<li class="chapter" data-level="4.2" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#checking-the-estimation-functions"><i class="fa fa-check"></i><b>4.2</b> Checking the estimation function(s)</a></li>
<li class="chapter" data-level="4.3" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#exercises-2"><i class="fa fa-check"></i><b>4.3</b> Exercises</a><ul>
<li class="chapter" data-level="4.3.1" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#estimation-helper-function"><i class="fa fa-check"></i><b>4.3.1</b> Estimation helper function</a></li>
<li class="chapter" data-level="4.3.2" data-path="estimation-procedures-1.html"><a href="estimation-procedures-1.html#the-bff-test"><i class="fa fa-check"></i><b>4.3.2</b> The BFF* test</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="performance-criteria.html"><a href="performance-criteria.html"><i class="fa fa-check"></i><b>5</b> Performance criteria</a><ul>
<li class="chapter" data-level="5.1" data-path="performance-criteria.html"><a href="performance-criteria.html#parameter-estimation-absolute-criteria"><i class="fa fa-check"></i><b>5.1</b> Parameter estimation: absolute criteria</a></li>
<li class="chapter" data-level="5.2" data-path="performance-criteria.html"><a href="performance-criteria.html#parameter-estimation-relative-criteria"><i class="fa fa-check"></i><b>5.2</b> Parameter estimation: relative criteria</a></li>
<li class="chapter" data-level="5.3" data-path="performance-criteria.html"><a href="performance-criteria.html#absolute-or-relative-performance"><i class="fa fa-check"></i><b>5.3</b> Absolute or relative performance?</a></li>
<li class="chapter" data-level="5.4" data-path="performance-criteria.html"><a href="performance-criteria.html#assessing-variance-estimators"><i class="fa fa-check"></i><b>5.4</b> Assessing variance estimators</a></li>
<li class="chapter" data-level="5.5" data-path="performance-criteria.html"><a href="performance-criteria.html#hypothesis-testing"><i class="fa fa-check"></i><b>5.5</b> Hypothesis testing</a></li>
<li class="chapter" data-level="5.6" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-intervals"><i class="fa fa-check"></i><b>5.6</b> Confidence intervals</a></li>
<li class="chapter" data-level="5.7" data-path="performance-criteria.html"><a href="performance-criteria.html#exercises-simulating-cronbachs-alpha"><i class="fa fa-check"></i><b>5.7</b> Exercises: Simulating Cronbach’s alpha</a><ul>
<li class="chapter" data-level="5.7.1" data-path="performance-criteria.html"><a href="performance-criteria.html#data-generating-function"><i class="fa fa-check"></i><b>5.7.1</b> data-generating function</a></li>
<li class="chapter" data-level="5.7.2" data-path="performance-criteria.html"><a href="performance-criteria.html#estimation-function"><i class="fa fa-check"></i><b>5.7.2</b> Estimation function</a></li>
<li class="chapter" data-level="5.7.3" data-path="performance-criteria.html"><a href="performance-criteria.html#replicates"><i class="fa fa-check"></i><b>5.7.3</b> Replicates</a></li>
<li class="chapter" data-level="5.7.4" data-path="performance-criteria.html"><a href="performance-criteria.html#estimator-performance"><i class="fa fa-check"></i><b>5.7.4</b> Estimator performance</a></li>
<li class="chapter" data-level="5.7.5" data-path="performance-criteria.html"><a href="performance-criteria.html#confidence-interval-coverage"><i class="fa fa-check"></i><b>5.7.5</b> Confidence interval coverage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="experimental-design-1.html"><a href="experimental-design-1.html"><i class="fa fa-check"></i><b>6</b> Experimental design</a><ul>
<li class="chapter" data-level="6.1" data-path="experimental-design-1.html"><a href="experimental-design-1.html#choosing-parameter-combinations"><i class="fa fa-check"></i><b>6.1</b> Choosing parameter combinations</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html"><i class="fa fa-check"></i><b>7</b> Putting the pieces together</a><ul>
<li class="chapter" data-level="7.1" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#organizing-the-script-for-a-simulation-study"><i class="fa fa-check"></i><b>7.1</b> Organizing the script for a simulation study</a></li>
<li class="chapter" data-level="7.2" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#data-generating-model-2"><i class="fa fa-check"></i><b>7.2</b> data-generating model</a></li>
<li class="chapter" data-level="7.3" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#estimation-procedures-2"><i class="fa fa-check"></i><b>7.3</b> estimation procedures</a></li>
<li class="chapter" data-level="7.4" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#performance-calculations"><i class="fa fa-check"></i><b>7.4</b> Performance calculations</a></li>
<li class="chapter" data-level="7.5" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#simulation-driver"><i class="fa fa-check"></i><b>7.5</b> Simulation driver</a></li>
<li class="chapter" data-level="7.6" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#experimental-design-2"><i class="fa fa-check"></i><b>7.6</b> Experimental design</a></li>
<li class="chapter" data-level="7.7" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#putting-it-all-together"><i class="fa fa-check"></i><b>7.7</b> Putting it all together</a><ul>
<li class="chapter" data-level="7.7.1" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#mdply-workflow"><i class="fa fa-check"></i><b>7.7.1</b> <code>mdply</code> workflow</a></li>
<li class="chapter" data-level="7.7.2" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#purrrlyr-workflow"><i class="fa fa-check"></i><b>7.7.2</b> <code>purrrlyr</code> workflow</a></li>
<li class="chapter" data-level="7.7.3" data-path="putting-the-pieces-together.html"><a href="putting-the-pieces-together.html#parallel-processing"><i class="fa fa-check"></i><b>7.7.3</b> parallel processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html"><i class="fa fa-check"></i><b>8</b> Design, analysis, and presentation of simulation results</a><ul>
<li class="chapter" data-level="8.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#designing-the-simulation-experiment"><i class="fa fa-check"></i><b>8.1</b> Designing the simulation experiment</a></li>
<li class="chapter" data-level="8.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#choosing-parameter-levels"><i class="fa fa-check"></i><b>8.2</b> Choosing parameter levels</a></li>
<li class="chapter" data-level="8.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation"><i class="fa fa-check"></i><b>8.3</b> Presentation</a></li>
<li class="chapter" data-level="8.4" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#tabulation"><i class="fa fa-check"></i><b>8.4</b> Tabulation</a></li>
<li class="chapter" data-level="8.5" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#visualization"><i class="fa fa-check"></i><b>8.5</b> Visualization</a><ul>
<li class="chapter" data-level="8.5.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1"><i class="fa fa-check"></i><b>8.5.1</b> Example 1</a></li>
<li class="chapter" data-level="8.5.2" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-2"><i class="fa fa-check"></i><b>8.5.2</b> Example 2</a></li>
<li class="chapter" data-level="8.5.3" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-3-pustejovsky-swan-2014"><i class="fa fa-check"></i><b>8.5.3</b> Example 3 (Pustejovsky &amp; Swan, 2014)</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#modeling"><i class="fa fa-check"></i><b>8.6</b> Modeling</a><ul>
<li class="chapter" data-level="8.6.1" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#example-1-1"><i class="fa fa-check"></i><b>8.6.1</b> Example 1</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="design-analysis-and-presentation-of-simulation-results.html"><a href="design-analysis-and-presentation-of-simulation-results.html#presentation-1"><i class="fa fa-check"></i><b>8.7</b> Presentation</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Designing Monte Carlo Simulations in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimation-procedures-1" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Estimation procedures</h1>
<p>In the abstract, a function that implements an estimation procedure should have the following form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">estimate &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {

  <span class="co"># calculations/model-fitting/estimation procedures</span>
  
  <span class="kw">return</span>(estimates)
}</code></pre></div>
<p>The function takes a set of simulated data as input, fits a model or otherwise calculates a set of estimates, and produces as output a set estimates. The estimates could be point-estimates of parameters, standard errors, confidence intervals, etc. Depending on the research question, this function might involve use of a combination of several procedures (e.g., a diagnostic test for heteroskedasticity, followed by the conventional formula or heteroskedasticity-robust formula for standard errors). Also depending on the research question, we might need to create <em>several</em> functions that implement different estimation procedures to be compared.</p>
<p>Brown and Forsythe considered four different hypothesis testing procedures for heteroskedastic ANOVA. For starters, let’s look at the simplest one, which is just to use a conventional one-way ANOVA (while mistakenly assuming homoskedasticity). The <code>oneway.test</code> function will calculate this test automatically:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_data &lt;-<span class="st"> </span><span class="kw">generate_data</span>(<span class="dt">mu =</span> mu, <span class="dt">sigma_sq =</span> sigma_sq, <span class="dt">sample_size =</span> sample_size)
<span class="kw">oneway.test</span>(x <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(group), <span class="dt">data =</span> sim_data, <span class="dt">var.equal =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## 
##  One-way analysis of means
## 
## data:  x and factor(group)
## F = 1.4487, num df = 3, denom df = 30, p-value = 0.2483</code></pre>
<p>The main result we need here is the p-value, which will let us assess the test’s Type-I error and power for a given nominal <span class="math inline">\(\alpha\)</span>-level. The following function takes simulated data as input and returns as output the p-value from a one-way ANOVA:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ANOVA_F_aov &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
  oneway_anova &lt;-<span class="st"> </span><span class="kw">oneway.test</span>(x <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(group), <span class="dt">data =</span> sim_data, <span class="dt">var.equal =</span> <span class="ot">TRUE</span>)
  <span class="kw">return</span>(oneway_anova<span class="op">$</span>p.value)
}

<span class="kw">ANOVA_F_aov</span>(sim_data)</code></pre></div>
<pre><code>## [1] 0.2483031</code></pre>
<p>An alternative approach would be to program the ANOVA F statistic and test directly. Following the formulas on p. 129 of Brown and Forsythe (1974):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ANOVA_F_direct &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
  
  x_bar &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, mean))
  s_sq &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, var))
  n &lt;-<span class="st"> </span><span class="kw">table</span>(sim_data<span class="op">$</span>group)
  g &lt;-<span class="st"> </span><span class="kw">length</span>(x_bar)
  
  df1 &lt;-<span class="st"> </span>g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  df2 &lt;-<span class="st"> </span><span class="kw">sum</span>(n) <span class="op">-</span><span class="st"> </span>g
  
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(n <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(sim_data<span class="op">$</span>x))<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>df1
  mswn &lt;-<span class="st"> </span><span class="kw">sum</span>((n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>s_sq) <span class="op">/</span><span class="st"> </span>df2
  fstat &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>mswn
  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(fstat, df1, df2, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)
 
  <span class="kw">return</span>(pval)
}

<span class="kw">ANOVA_F_direct</span>(sim_data)</code></pre></div>
<pre><code>## [1] 0.2483031</code></pre>
<p>This approach takes more work to program, but will end up being quicker to compute. To see the difference, we’ll use an R package called <code>microbenchmark</code> to test how long the computations take for each version of the function. The <code>microbenchmark</code> function runs each expression 100 times (by default) and tracks how long the computations take. It then summarizes the distribution of timings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(microbenchmark)
timings &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">Rfunction =</span> <span class="kw">ANOVA_F_aov</span>(sim_data),
                          <span class="dt">direct    =</span> <span class="kw">ANOVA_F_direct</span>(sim_data))
timings</code></pre></div>
<pre><code>## Unit: microseconds
##       expr      min       lq      mean    median       uq      max neval
##  Rfunction 1073.957 1110.559 1232.1837 1127.8575 1188.885 3915.630   100
##     direct  594.315  624.356  665.0061  638.4915  685.986  811.927   100</code></pre>
<p>The direct function is 1.9 times faster than the built-in R function.</p>
<p>This result is pretty typical. Built-in R functions usually include lots of checks and error-handling, which take time to compute. These checks are crucial for messy, real-world data analysis but unnecessary with our pristine, simulated data. Here we can skip them by doing the calculations directly.</p>
<p>Now let’s consider another one of the tests considered by Brown and Forsythe. Here is a function that calculates the Welch test, again following the notation and formulas from the paper:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Welch_F &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
   
  x_bar &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, mean))
  s_sq &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, var))
  n &lt;-<span class="st"> </span><span class="kw">table</span>(sim_data<span class="op">$</span>group)
  g &lt;-<span class="st"> </span><span class="kw">length</span>(x_bar)

  w &lt;-<span class="st"> </span>n <span class="op">/</span><span class="st"> </span>s_sq
  u &lt;-<span class="st"> </span><span class="kw">sum</span>(w)
  x_tilde &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>x_bar) <span class="op">/</span><span class="st"> </span>u
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span>x_tilde)<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)

  G &lt;-<span class="st"> </span><span class="kw">sum</span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>w <span class="op">/</span><span class="st"> </span>u)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))
  denom &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st">  </span>G <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
  W &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>denom
  f &lt;-<span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>G)

  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(W, <span class="dt">df1 =</span> g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">df2 =</span> f, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)

  <span class="kw">return</span>(pval)
}

<span class="kw">Welch_F</span>(sim_data)</code></pre></div>
<pre><code>## [1] 0.4172818</code></pre>
<div id="efficiency-considerations" class="section level2">
<h2><span class="header-section-number">4.1</span> Efficiency considerations</h2>
<p>Computational efficiency is usually a secondary consideration when you’re starting to design a simulation study. It’s better to produce accurate code, even if it’s a bit slow, than to use write code that is speedy but hard to follow (or even worse, that produces incorrect results). All that said, there is some glaring redundancy in the two functions we’ve looked at so far. Both of them start by taking the simulated data and calculating summary statistics for each group, using the following code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x_bar &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, mean))
s_sq &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, var))
n &lt;-<span class="st"> </span><span class="kw">table</span>(sim_data<span class="op">$</span>group)
g &lt;-<span class="st"> </span><span class="kw">length</span>(x_bar)</code></pre></div>
<p>In the interest of not repeating ourselves, it would better to pull this code out as a separate function and then re-write the <code>ANOVA_F</code> and <code>Welch_F</code> functions to take the summary statistics as input. Here is a function that takes simulated data and returns a list of summary statistics:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summarize_data &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
  
  x_bar &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, mean))
  s_sq &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, var))
  n &lt;-<span class="st"> </span><span class="kw">table</span>(sim_data<span class="op">$</span>group)
  g &lt;-<span class="st"> </span><span class="kw">length</span>(x_bar)
  
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
}

<span class="kw">summarize_data</span>(sim_data)</code></pre></div>
<pre><code>## $x_bar
##          1          2          3          4 
## -0.3545704 -0.9992128  1.3785627  0.2061606 
## 
## $s_sq
##         1         2         3         4 
## 13.824046 11.439700  5.319099  1.305822 
## 
## $n
## 
##  1  2  3  4 
##  4  8 10 12 
## 
## $g
## [1] 4</code></pre>
<p>Now we can re-write the F-test functions to use the output of this function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ANOVA_F &lt;-<span class="st"> </span><span class="cf">function</span>(x_bar, s_sq, n, g) {
  
  df1 &lt;-<span class="st"> </span>g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  df2 &lt;-<span class="st"> </span><span class="kw">sum</span>(n) <span class="op">-</span><span class="st"> </span>g
  
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(n <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span><span class="kw">weighted.mean</span>(x_bar, <span class="dt">w =</span> n))<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>df1
  mswn &lt;-<span class="st"> </span><span class="kw">sum</span>((n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>s_sq) <span class="op">/</span><span class="st"> </span>df2
  fstat &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>mswn
  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(fstat, df1, df2, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)
 
  <span class="kw">return</span>(pval)
}

summary_stats &lt;-<span class="st"> </span><span class="kw">summarize_data</span>(sim_data)
<span class="kw">with</span>(summary_stats, <span class="kw">ANOVA_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))</code></pre></div>
<pre><code>## [1] 0.2483031</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Welch_F &lt;-<span class="st"> </span><span class="cf">function</span>(x_bar, s_sq, n, g) {
   
  w &lt;-<span class="st"> </span>n <span class="op">/</span><span class="st"> </span>s_sq
  u &lt;-<span class="st"> </span><span class="kw">sum</span>(w)
  x_tilde &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>x_bar) <span class="op">/</span><span class="st"> </span>u
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span>x_tilde)<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)

  G &lt;-<span class="st"> </span><span class="kw">sum</span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>w <span class="op">/</span><span class="st"> </span>u)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))
  denom &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st">  </span>G <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
  W &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>denom
  f &lt;-<span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>G)

  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(W, <span class="dt">df1 =</span> g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">df2 =</span> f, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)

  <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">W =</span> W, <span class="dt">f =</span> f, <span class="dt">pval =</span> pval))
}

<span class="kw">with</span>(summary_stats, <span class="kw">Welch_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))</code></pre></div>
<pre><code>##          W        f      pval
## 1 1.043552 9.458841 0.4172818</code></pre>
<p>The results are the same as before.</p>
</div>
<div id="checking-the-estimation-functions" class="section level2">
<h2><span class="header-section-number">4.2</span> Checking the estimation function(s)</h2>
<p>Just as with the data-generating function, it is important to verify the accuracy of the estimation functions. For the ANOVA-F test, this can be done simply by checking the result of <code>ANOVA_F</code> against the built-in <code>oneway.test</code> function. Let’s do that with a fresh set of data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_data &lt;-<span class="st"> </span><span class="kw">generate_data</span>(<span class="dt">mu =</span> mu, <span class="dt">sigma_sq =</span> sigma_sq, <span class="dt">sample_size =</span> sample_size)
aov_results &lt;-<span class="st"> </span><span class="kw">oneway.test</span>(x <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(group), <span class="dt">data =</span> sim_data, <span class="dt">var.equal =</span> <span class="ot">TRUE</span>)
aov_results</code></pre></div>
<pre><code>## 
##  One-way analysis of means
## 
## data:  x and factor(group)
## F = 2.5599, num df = 3, denom df = 30, p-value = 0.07358</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summary_stats &lt;-<span class="st"> </span><span class="kw">summarize_data</span>(sim_data)
F_results &lt;-<span class="st"> </span><span class="kw">with</span>(summary_stats, <span class="kw">ANOVA_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
F_results</code></pre></div>
<pre><code>## [1] 0.07357847</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(aov_results<span class="op">$</span>p.value, F_results)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>We can follow the same approach to check the results of the Welch test because it is also implemented in <code>oneway.test</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aov_results &lt;-<span class="st"> </span><span class="kw">oneway.test</span>(x <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(group), <span class="dt">data =</span> sim_data, <span class="dt">var.equal =</span> <span class="ot">FALSE</span>)
aov_results</code></pre></div>
<pre><code>## 
##  One-way analysis of means (not assuming equal variances)
## 
## data:  x and factor(group)
## F = 2.5941, num df = 3.000, denom df = 10.468, p-value = 0.1081</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">W_results &lt;-<span class="st"> </span><span class="kw">with</span>(summary_stats, <span class="kw">Welch_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
W_results</code></pre></div>
<pre><code>##          W        f      pval
## 1 2.594102 10.46754 0.1080978</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(aov_results<span class="op">$</span>p.value, W_results<span class="op">$</span>pval)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Checking estimation functions can be a bit more difficult for procedures that are not already implemented in R. For example, the two other procedures examined by Brown and Forsythe, the James’ test and Brown and Forsythe’s <span class="math inline">\(F*\)</span> test, are not available in base R. They are available in the user-contributed package <code>onewaytests</code> (I found this by searching for “Brown-Forsythe” at <a href="http://rseek.org/" class="uri">http://rseek.org/</a>). We could benchmark our calculations against this package, but of course there is some risk that the package might not be correct. Another route is to verify your results on numerical examples reported in authoritative papers, on the assumption that there’s less risk of an error there. In the original paper that proposed the test, Welch (1951) provides a worked numerical example of the procedure. He reports the following summary statistics:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="dv">3</span>
x_bar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">27.8</span>, <span class="fl">24.1</span>, <span class="fl">22.2</span>)
s_sq &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">60.1</span>, <span class="fl">6.3</span>, <span class="fl">15.4</span>)
n &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">10</span>)</code></pre></div>
<p>He also reports <span class="math inline">\(W = 3.35\)</span> and <span class="math inline">\(f = 22.6\)</span>. Replicating the calculations with our <code>Welch_F</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">Welch_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g)</code></pre></div>
<pre><code>##          W        f       pval
## 1 3.344116 21.06575 0.05479049</code></pre>
<p>We get slightly different results! But we know that our function is correct—or at least consistent with <code>oneway.test</code>—so what’s going on? It turns out that there was an error in some of Welch’s intermediate calculations, which can only be spotted because he reported all of his work in the paper.</p>
</div>
<div id="exercises-2" class="section level2">
<h2><span class="header-section-number">4.3</span> Exercises</h2>
<p>The following exercises involve exploring and tweaking the simulation code we’ve developed to replicate the results of Brown and Forsythe (1974). Here are the key functions for the data-generating process and estimation procedures:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">generate_data &lt;-<span class="st"> </span><span class="cf">function</span>(mu, sigma_sq, sample_size) {

  N &lt;-<span class="st"> </span><span class="kw">sum</span>(sample_size) 
  g &lt;-<span class="st"> </span><span class="kw">length</span>(sample_size) 
  
  group &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>g, <span class="dt">times =</span> sample_size) 
  mu_long &lt;-<span class="st"> </span><span class="kw">rep</span>(mu, <span class="dt">times =</span> sample_size)
  sigma_long &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">sqrt</span>(sigma_sq), <span class="dt">times =</span> sample_size) 
  
  x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dt">mean =</span> mu_long, <span class="dt">sd =</span> sigma_long)
  sim_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">group =</span> group, <span class="dt">x =</span> x)
    
  <span class="kw">return</span>(sim_data)
}

summarize_data &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
  
  x_bar &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, mean))
  s_sq &lt;-<span class="st"> </span><span class="kw">with</span>(sim_data, <span class="kw">tapply</span>(x, group, var))
  n &lt;-<span class="st"> </span><span class="kw">table</span>(sim_data<span class="op">$</span>group)
  g &lt;-<span class="st"> </span><span class="kw">length</span>(x_bar)
  
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
}

ANOVA_F &lt;-<span class="st"> </span><span class="cf">function</span>(x_bar, s_sq, n, g) {
  
  df1 &lt;-<span class="st"> </span>g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  df2 &lt;-<span class="st"> </span><span class="kw">sum</span>(n) <span class="op">-</span><span class="st"> </span>g
  
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(n <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span><span class="kw">weighted.mean</span>(x_bar, <span class="dt">w =</span> n))<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>df1
  mswn &lt;-<span class="st"> </span><span class="kw">sum</span>((n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>s_sq) <span class="op">/</span><span class="st"> </span>df2
  fstat &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>mswn
  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(fstat, df1, df2, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)
 
  <span class="kw">return</span>(pval)
}

Welch_F &lt;-<span class="st"> </span><span class="cf">function</span>(x_bar, s_sq, n, g) {
   
  w &lt;-<span class="st"> </span>n <span class="op">/</span><span class="st"> </span>s_sq
  u &lt;-<span class="st"> </span><span class="kw">sum</span>(w)
  x_tilde &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>x_bar) <span class="op">/</span><span class="st"> </span>u
  msbtw &lt;-<span class="st"> </span><span class="kw">sum</span>(w <span class="op">*</span><span class="st"> </span>(x_bar <span class="op">-</span><span class="st"> </span>x_tilde)<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)

  G &lt;-<span class="st"> </span><span class="kw">sum</span>((<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>w <span class="op">/</span><span class="st"> </span>u)<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))
  denom &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st">  </span>G <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(g <span class="op">-</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
  W &lt;-<span class="st"> </span>msbtw <span class="op">/</span><span class="st"> </span>denom
  f &lt;-<span class="st"> </span>(g<span class="op">^</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>G)

  pval &lt;-<span class="st"> </span><span class="kw">pf</span>(W, <span class="dt">df1 =</span> g <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">df2 =</span> f, <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)

  <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">W =</span> W, <span class="dt">f =</span> f, <span class="dt">pval =</span> pval))
}</code></pre></div>
<div id="estimation-helper-function" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Estimation helper function</h3>
<p>Write a helper function that rolls up the <code>summarize_data</code>, <code>ANOVA_F</code>, and <code>Welch_F</code> functions and outputs p-values for the ANOVA F-test and the Welch test. Here’s a skeleton to fill in:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">calculate_pvals &lt;-<span class="st"> </span><span class="cf">function</span>(sim_data) {
  
  <span class="co"># fill in the guts here</span>
  
  <span class="kw">return</span>(pvals)
}</code></pre></div>
<p>Use the helper function to simplify the following <code>replicate</code> call (you’ll need to change <code>eval</code> to <code>TRUE</code> in the header of this code chunk for the code to compile when you knit):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>)
sample_size &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>)
sigma_sq &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)<span class="op">^</span><span class="dv">2</span>
p_vals &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dt">n =</span> <span class="dv">10000</span>, {
  sim_data &lt;-<span class="st"> </span><span class="kw">generate_data</span>(<span class="dt">mu =</span> mu, <span class="dt">sigma_sq =</span> sigma_sq, <span class="dt">sample_size =</span> sample_size) 
  summary_stats &lt;-<span class="st"> </span><span class="kw">summarize_data</span>(sim_data)
  anova_p &lt;-<span class="st"> </span><span class="kw">with</span>(summary_stats, <span class="kw">ANOVA_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
  Welch &lt;-<span class="st"> </span><span class="kw">with</span>(summary_stats, <span class="kw">Welch_F</span>(<span class="dt">x_bar =</span> x_bar, <span class="dt">s_sq =</span> s_sq, <span class="dt">n =</span> n, <span class="dt">g =</span> g))
  <span class="kw">data.frame</span>(<span class="dt">ANOVA =</span> anova_p, <span class="dt">Welch =</span> Welch<span class="op">$</span>pval)
}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="the-bff-test" class="section level3">
<h3><span class="header-section-number">4.3.2</span> The BFF* test</h3>
<p>Write a function that implements the Brown-Forsythe F*-test (the BFF* test!) as described on p. 130 of Brown and Forsythe (1974). Incorporate the function into the <code>calculate_pvals</code> function from the previous question, and use it to estimate rejection rates of the BFF* test for the parameter values in the fifth line of Table 1 (which are the same as those used in the previous question).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">BF_F &lt;-<span class="st"> </span><span class="cf">function</span>(x_bar, s_sq, n, g) {
  
  <span class="co"># fill in the guts here</span>
  
  <span class="kw">return</span>(<span class="dt">pval =</span> pval)
}

<span class="co"># Further R code here</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-generating-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="performance-criteria.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/03-Estimation-procedures.Rmd",
"text": "Edit"
},
"download": ["Designing-Simulations-in-R.pdf", "Designing-Simulations-in-R.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
